name: Analysis

on:
  workflow_dispatch: # 允许你手动点击运行

jobs:
  check-home-access:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 下载最新qlib_bin.tar.gz
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. 下载名为 qlib_bin.tar.gz 的附件到当前目录
          gh release download --repo chenditc/investment_data --pattern "qlib_bin.tar.gz"

          # 2. 解压文件
          echo ">>> 正在解压数据..."
          mkdir -p ~/.qlib/qlib_data/cn_data

          tar -zxf qlib_bin.tar.gz -C ~/.qlib/qlib_data/cn_data --strip-components=1
          
          # 3. 验证解压后的内容
          tail -n1   ~/.qlib/qlib_data/cn_data/calendars/day.txt

      - name: 2. Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main         # 显式指定拉取 main 分支
          fetch-depth: 1    # 只拉取最新一次提交以节省时间

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12' # 建议使用 '3.12' 匹配最新稳定补丁，若强行指定不存在的版本会报错

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "⚠️ 警告: 未找到 requirements.txt，跳过安装。"
          fi


      - name: 3. Decompress with absolute paths
        run: |
          echo ">>> 检查压缩包是否存在..."
          if [ -f "./model_pkl/qlib_mlruns.tar.gz" ]; then
            echo "✅ 找到压缩包，开始执行绝对路径解压..."
            # 使用 sudo 确保有权限写入 /home 或其他系统目录
            sudo tar --absolute-names -xzf ./model_pkl/qlib_mlruns.tar.gz
            echo "✅ 解压完成"
          else
            echo "❌ 错误: 在 ./model_pkl/ 目录下未找到 qlib_mlruns.tar.gz"
            exit 1
          fi

      - name: 4. Verify decompressed files
        run: |
          echo ">>> 验证 /home/ash/ 目录下的内容:"
          # 使用 sudo ls 以防权限限制
          sudo ls -R /home/ash/.qlibAssistant/mlruns/ || echo "目录尚未创建"

          echo ">>> 修复目录权限..."
          # 将 /home/ash 及其所有子内容的所有者改为当前用户
          # 这样后续的 Python 脚本就有权读写该目录了
          sudo chown -R $USER:$USER /home/ash/
          
          # 顺便给目录最高权限（可选，双重保险）
          sudo chmod -R 755 /home/ash/
          
          echo "✅ 权限修复完成"

      - name: 5. Run analysis
        run: |
            echo ">>> 运行分析脚本..."
            # cd ./roll && python ./roll.py model ls all=1
            cd ./roll && python ./roll.py model selection

      - name: 提交分析结果到 qlib_score 分支
        run: |
          # 1. 配置 Git 机器人身份
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 2. 创建临时目录存放要保存的文件 (防止切换分支时被 git checkout 删掉)
          echo ">>> 正在暂存分析结果..."
          mkdir -p /tmp/save_results
          cp -r /home/ash/.qlibAssistant/anilysis/* /tmp/save_results/

          # 3. 切换分支逻辑
          git fetch origin
          if git show-ref --quiet refs/remotes/origin/qlib_score; then
            git checkout qlib_score
            git pull origin qlib_score
          else
            git checkout -b qlib_score
          fi

          # 4. 将文件放入指定文件夹 qlib_score_csv
          echo ">>> 正在更新 qlib_score_csv 文件夹..."
          mkdir -p qlib_score_csv
          cp -r /tmp/save_results/* qlib_score_csv/

          # 5. 提交并推送
          git add qlib_score_csv/

          # 检查是否有文件变化，避免空提交报错
          if git diff --cached --quiet; then
            echo "今日分析结果无变化，跳过推送。"
          else
            git commit -m "自动更新分析评分: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin qlib_score
          fi